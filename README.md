# Directus CI/CD Pipeline — AWS Deployment

A fully automated CI/CD pipeline that provisions AWS infrastructure via Terraform, deploys [Directus](https://directus.io) (headless CMS) via Docker Compose over SSH, validates the deployment, and provides infrastructure cleanup.

## Architecture

```
GitLab CI/CD Pipeline
├── validate  → Lint & validate Terraform + Docker configs
├── plan      → Terraform execution plan preview
├── provision → Terraform apply (EC2 + Security Group + SSH Key)
├── deploy    → SSH into server, deploy Directus via Docker Compose
├── test      → Health checks, homepage capture, deployment report
└── cleanup   → Terraform destroy (manual trigger)

AWS Resources
├── EC2 t2.micro (Ubuntu 22.04 LTS)
├── Security Group (ports 22, 80, 8055)
└── Key Pair (RSA 4096-bit, generated by Terraform)
```

## Project Structure

```
directus-cicd/
├── terraform/
│   ├── main.tf          # AWS resources (EC2, SG, key pair, TLS key)
│   ├── variables.tf     # Input variables
│   ├── outputs.tf       # Instance IP, Directus URL, SSH private key
│   ├── versions.tf      # Provider version constraints
│   └── terraform.tfvars # Variable values (gitignored)
├── docker-compose.yml   # Directus + PostgreSQL services
├── .gitlab-ci.yml       # Full CI/CD pipeline definition
├── .gitignore           # Excludes secrets, state files, .env
└── README.md
```

## GitLab CI/CD Variables Required

Set these in **Settings → CI/CD → Variables** in your GitLab project:

| Variable | Description | Masked |
|---|---|---|
| `AWS_ACCESS_KEY_ID` | AWS access key | Yes |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key | Yes |
| `AWS_DEFAULT_REGION` | AWS region (e.g. `us-east-1`) | No |
| `ADMIN_EMAIL` | Directus admin email | No |
| `ADMIN_PASSWORD` | Directus admin password | Yes |
| `DB_PASSWORD` | PostgreSQL password | Yes |
| `DIRECTUS_SECRET` | Directus secret key | Yes |

## Pipeline Flow

```
Push → [validate ✅] → [plan ✅] → [provision ▶ MANUAL] → [deploy ✅] → [test ✅] → [cleanup ▶ MANUAL]
```

- **Auto stages**: validate, plan, deploy, test
- **Manual stages**: provision (terraform apply), cleanup (terraform destroy)

## Accessing Directus

After the deploy stage completes:
- **URL**: `http://<SERVER_IP>:8055`
- **Admin**: `http://<SERVER_IP>:8055/admin`
- Login with `ADMIN_EMAIL` / `ADMIN_PASSWORD` from your CI/CD variables

## Security

- SSH private key is generated by Terraform and stored only in CI/CD artifacts
- `.env` is generated on-the-fly on the server from GitLab CI/CD variables — never committed
- All secrets are stored as masked GitLab CI/CD variables
- `terraform.tfvars` and `*.pem` files are gitignored

## Local Validation (Optional)

```bash
cd terraform
terraform init -backend=false
terraform validate
terraform fmt -check
```

> **Do NOT run `terraform apply` locally.** Let the CI/CD pipeline handle provisioning.
