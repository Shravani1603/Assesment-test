name: Directus CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  TF_VERSION: "1.7.0"

jobs:
  # ─────────────────────────────────────────
  # STAGE 1: VALIDATE
  # ─────────────────────────────────────────
  terraform_validate:
    name: "Validate: Terraform"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      - name: Terraform Init
        run: terraform init -backend=false
      - name: Terraform Validate
        run: terraform validate

  docker_validate:
    name: "Validate: Docker Compose"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config --quiet

  # ─────────────────────────────────────────
  # STAGE 2: PLAN
  # ─────────────────────────────────────────
  terraform_plan:
    name: "Plan: Terraform"
    runs-on: ubuntu-latest
    needs: [terraform_validate, docker_validate]
    defaults:
      run:
        working-directory: terraform
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      - name: Terraform Init
        run: terraform init -backend=false
      - name: Terraform Plan
        run: |
          terraform plan \
            -var="aws_region=${{ secrets.AWS_DEFAULT_REGION }}" \
            -var="ami_id=ami-0b6c6ebed2801a5cb" \
            -var="project_name=directus-cicd" \
            -var="instance_type=t2.micro" \
            -var="environment=production" \
            -no-color

  # ─────────────────────────────────────────
  # STAGE 3: PROVISION
  # ─────────────────────────────────────────
  terraform_apply:
    name: "Provision: Terraform Apply"
    runs-on: ubuntu-latest
    needs: [terraform_plan]
    environment: production
    defaults:
      run:
        working-directory: terraform
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      - name: Terraform Init
        run: terraform init -backend=false
      - name: Terraform Apply
        run: |
          terraform apply \
            -var="aws_region=${{ secrets.AWS_DEFAULT_REGION }}" \
            -var="ami_id=ami-0b6c6ebed2801a5cb" \
            -var="project_name=directus-cicd" \
            -var="instance_type=t2.micro" \
            -var="environment=production" \
            -state=terraform.tfstate \
            -auto-approve \
            -no-color
      - name: Extract and Clean Outputs
        run: |
          # 1. Extract IP and remove ALL non-IP characters (digits and dots only)
          RAW_IP=$(terraform output -state=terraform.tfstate -raw instance_public_ip)
          CLEAN_IP=$(echo "$RAW_IP" | sed 's/[^0-9.]*//g' | head -n 1)
          
          # 2. Validate IP format (basic regex)
          if [[ ! "$CLEAN_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid IP format extracted: '$CLEAN_IP' (Raw was: '$RAW_IP')"
            exit 1
          fi
          
          echo "Cleaned IP: $CLEAN_IP"
          echo "$CLEAN_IP" > ../server_ip.txt
          
          # 3. Extract Private Key
          terraform output -state=terraform.tfstate -raw private_key_pem > ../ssh_key.pem
          chmod 600 ../ssh_key.pem
          
          # 4. Extract URL
          terraform output -state=terraform.tfstate -raw directus_url > ../directus_url.txt
          
          echo "Infrastructure ready. IP: $CLEAN_IP"
          sleep 120
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-connection-details
          path: |
            server_ip.txt
            ssh_key.pem
            directus_url.txt
            terraform/terraform.tfstate
          retention-days: 1

  # ─────────────────────────────────────────
  # STAGE 4: DEPLOY
  # ─────────────────────────────────────────
  deploy_directus:
    name: "Deploy: Directus via SSH"
    runs-on: ubuntu-latest
    needs: [terraform_apply]
    steps:
      - uses: actions/checkout@v4
      - name: Download connection artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-connection-details
      - name: Robust SSH User Detection
        run: |
          # Ensure IP is clean
          SERVER_IP=$(cat server_ip.txt | sed 's/[^0-9.]*//g' | head -n 1)
          if [ -z "$SERVER_IP" ]; then echo "IP missing"; exit 1; fi
          chmod 600 ssh_key.pem
          
          echo "Connecting to IP: [$SERVER_IP]"
          
          # List of potential users for the custom AMI
          USERS=("ubuntu" "ec2-user" "admin" "root")
          DETECTED_USER=""
          
          for i in $(seq 1 40); do
            for user in "${USERS[@]}"; do
              echo "Attempt $i/40: Trying $user..."
              if ssh -i ssh_key.pem -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$user@$SERVER_IP" "hostname" 2>/dev/null; then
                echo "$user" > ssh_user.txt
                DETECTED_USER=$user
                echo "Success: Logged in as $user"
                break 2
              fi
            done
            echo "Waiting for SSH server readiness..."
            sleep 15
          done
          
          if [ -z "$DETECTED_USER" ]; then 
            echo "Failed to connect to $SERVER_IP via SSH as any known user."
            exit 1
          fi
      - name: Wait for Docker
        run: |
          SERVER_IP=$(cat server_ip.txt | sed 's/[^0-9.]*//g' | head -n 1)
          SSH_USER=$(cat ssh_user.txt)
          echo "Checking Docker as $SSH_USER..."
          for i in $(seq 1 20); do
            if ssh -i ssh_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$SERVER_IP" "docker info" >/dev/null 2>&1; then
              echo "Docker found!"
              break
            fi
            echo "Docker not yet running... attempt $i/20"
            sleep 20
          done
      - name: Deploy Directus
        run: |
          SERVER_IP=$(cat server_ip.txt | sed 's/[^0-9.]*//g' | head -n 1)
          SSH_USER=$(cat ssh_user.txt)
          
          ssh -i ssh_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$SERVER_IP" "mkdir -p ~/directus"
          scp -i ssh_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null docker-compose.yml "$SSH_USER@$SERVER_IP:~/directus/docker-compose.yml"
          
          # Securely write .env without local expansion bugs
          ssh -i ssh_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$SERVER_IP" "cat << 'EOF' > ~/directus/.env
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SECRET=${{ secrets.DIRECTUS_SECRET }}
          SERVER_IP=$SERVER_IP
          EOF"
          
          ssh -i ssh_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$SERVER_IP" "cd ~/directus && docker compose up -d"
      - name: Application Health Check
        run: |
          SERVER_IP=$(cat server_ip.txt | sed 's/[^0-9.]*//g' | head -n 1)
          echo "Broadcasting health checks to http://$SERVER_IP:8055 ..."
          for i in $(seq 1 20); do
            if curl -s -f "http://$SERVER_IP:8055/server/ping"; then
              echo "Directus is LIVE!"
              exit 0
            fi
            sleep 20
          done
          echo "App failed to start in time."
          exit 1

  # ─────────────────────────────────────────
  # STAGE 5: TEST
  # ─────────────────────────────────────────
  test:
    name: "Final Verification"
    runs-on: ubuntu-latest
    needs: [deploy_directus]
    steps:
      - name: Download connection artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-connection-details
      - name: Final Result
        run: |
          SERVER_IP=$(cat server_ip.txt | sed 's/[^0-9.]*//g' | head -n 1)
          echo "----------------------------------------"
          echo "DEPLOYMENT SUCCESSFUL"
          echo "Directus URL: http://$SERVER_IP:8055"
          echo "Admin Panel: http://$SERVER_IP:8055/admin"
          echo "----------------------------------------"

  # ─────────────────────────────────────────
  # STAGE 6: CLEANUP (MANUAL)
  # ─────────────────────────────────────────
  cleanup:
    name: "Tear Down Resources"
    runs-on: ubuntu-latest
    needs: [test]
    environment: cleanup
    defaults:
      run:
        working-directory: terraform
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
    steps:
      - uses: actions/checkout@v4
      - name: Download connection details (State)
        uses: actions/download-artifact@v4
        with:
          name: server-connection-details
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      - name: Restore State and Destroy
        run: |
          find .. -name "terraform.tfstate" -exec cp {} . \;
          terraform init -backend=false
          terraform destroy \
            -var="aws_region=${{ secrets.AWS_DEFAULT_REGION }}" \
            -var="ami_id=ami-0b6c6ebed2801a5cb" \
            -var="project_name=directus-cicd" \
            -var="instance_type=t2.micro" \
            -var="environment=production" \
            -state=terraform.tfstate \
            -auto-approve
